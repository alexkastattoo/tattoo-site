<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pic ‚Üí Tattoo Reference | Alex Kas Tattoo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #05060a;
      --panel: #101119;
      --panel-soft: #171826;
      --accent: #ff5a3c;
      --accent-soft: rgba(255,90,60,0.16);
      --border: #2a2b3c;
      --text-main: #f5f5fa;
      --text-muted: #a1a2ba;
      --radius-lg: 18px;
      --radius-md: 11px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.6);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #171829 0, #05060a 50%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1180px;
      background: radial-gradient(circle at top left, #1f2135 0, #05060a 55%);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 28px 28px 26px;
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.05fr);
      gap: 24px;
    }

    @media (max-width: 900px) {
      .shell {
        grid-template-columns: minmax(0,1fr);
        padding: 20px 16px 18px;
        border-radius: 22px;
      }
    }

    header {
      grid-column: 1 / -1;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .brand {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    h1 {
      margin: 4px 0 4px;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 420px;
      line-height: 1.5;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 11px;
      color: var(--text-muted);
      background: radial-gradient(circle at left, rgba(255,255,255,0.14), rgba(0,0,0,0.5));
      white-space: nowrap;
    }

    .col {
      background: linear-gradient(145deg, var(--panel) 0, #05060a 100%);
      border-radius: 20px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(255,255,255,0.06);
      position: relative;
      overflow: hidden;
    }

    .col::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.06), transparent 55%);
      pointer-events: none;
    }

    .col-inner { position: relative; z-index: 1; }

    .label-muted {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .dropzone {
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(255,255,255,0.25);
      background: radial-gradient(circle at top, rgba(255,255,255,0.06), rgba(9,10,16,0.95));
      padding: 32px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.15s ease, background 0.15s ease, transform 0.15s ease;
    }

    .dropzone.dragover {
      border-color: var(--accent);
      background: radial-gradient(circle at top, rgba(255,90,60,0.20), rgba(3,4,8,0.96));
      transform: translateY(-1px);
    }

    .dropzone-title {
      font-size: 15px;
      font-weight: 600;
    }

    .dropzone-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    input[type="file"] { display: none; }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.12s ease, box-shadow 0.12s ease,
        opacity 0.12s ease;
      white-space: nowrap;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #ff7652 0, var(--accent) 55%);
      color: #120809;
      font-weight: 600;
      box-shadow: 0 12px 26px rgba(255,90,60,0.4);
    }

    .btn-primary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(255,90,60,0.55);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.03);
      color: var(--text-main);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .btn-secondary:not(:disabled):hover {
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }

    .preset-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .preset-note span {
      color: #f5f5fa;
    }

    .modes {
      margin-top: 18px;
      padding: 10px 12px;
      border-radius: 13px;
      background: rgba(10,11,18,0.9);
      border: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
    }

    .mode-label {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mode-label input {
      margin: 0;
      accent-color: var(--accent);
    }

    .sliders {
      margin-top: 14px;
      padding: 10px 12px 2px;
      border-radius: 14px;
      background: var(--panel-soft);
      border: 1px solid rgba(255,255,255,0.05);
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 8px;
    }

    .slider-group {
      display: grid;
      grid-template-columns: minmax(0,1fr) auto;
      column-gap: 8px;
      row-gap: 2px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .slider-group strong {
      font-size: 11px;
      color: var(--text-main);
      font-weight: 500;
    }

    .slider-value {
      font-variant-numeric: tabular-nums;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: #242537;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
      cursor: pointer;
      border: none;
    }

    input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      box-shadow: 0 0 0 4px var(--accent-soft);
      cursor: pointer;
    }

    .preview-wrapper {
      border-radius: 18px;
      padding: 10px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.04), rgba(3,4,8,0.96));
      border: 1px solid rgba(255,255,255,0.06);
      min-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .preview-header span.title-label {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 10px;
    }

    .view-toggle {
      display: inline-flex;
      gap: 4px;
      background: rgba(5,6,12,0.9);
      border-radius: 999px;
      padding: 2px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .view-btn {
      font-size: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .view-btn.active {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .preview-area {
      position: relative;
      flex: 1;
      border-radius: 14px;
      background: #05060a;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }

    .preview-placeholder {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      padding: 24px 12px;
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .preview-placeholder .icon {
      font-size: 22px;
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .meta {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .meta strong { font-weight: 500; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <div class="brand">Alex Kas Tattoo ‚Ä¢ Tool</div>
        <h1>Pic ‚Üí Tattoo Reference</h1>
        <div class="subtitle">
          Upload any photo and convert it into a clean, high-contrast black &amp; grey tattoo reference.
          All processing runs locally in your browser.
        </div>
      </div>
      <div class="pill">Preset tuned for soft black &amp; grey realism</div>
    </header>

    <!-- LEFT: controls -->
    <section class="col">
      <div class="col-inner">
        <div class="label-muted">Input</div>

        <label class="dropzone" id="dropzone">
          <div class="dropzone-title">Drop image here</div>
          <div class="dropzone-sub">or click to choose JPG / PNG / WEBP</div>
          <input type="file" id="fileInput" accept="image/*" />
        </label>

        <div class="buttons">
          <button class="btn-primary" id="processBtn" disabled>Process to Tattoo Ref</button>
          <button class="btn-secondary" id="downloadBtn" disabled>Download result</button>
          <button class="btn-secondary" id="resetBtn">Reset</button>
        </div>

        <div class="preset-note">
          <span>Mode 1 ‚Äì Tattoo Ref:</span> grayscale, contrast, clarity, light smoothing.<br/>
          <span>Mode 2 ‚Äì Soft Sketch:</span> —É–±–∏—Ä–∞–µ—Ç –º–µ–ª–∫–∏–µ –¥–µ—Ç–∞–ª–∏, –æ—Å—Ç–∞–≤–ª—è–µ—Ç –º—è–≥–∫—É—é —Å–≤–µ—Ç–æ—Ç–µ–Ω—å –ø–æ–¥
          smudge/brush –≤ Procreate. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª—ë–≥–∫—É—é –∫–∞—Ä–∞–Ω–¥–∞—à–Ω—É—é —Ç–µ–∫—Å—Ç—É—Ä—É.
        </div>

        <div class="modes">
          <label class="mode-label">
            <input type="radio" name="mode" value="tattoo" checked />
            Tattoo Ref
          </label>
          <label class="mode-label">
            <input type="radio" name="mode" value="sketch" />
            Soft Sketch (simplified tones)
          </label>
        </div>

        <!-- Tattoo Ref sliders -->
        <div class="sliders" id="slidersTattoo">
          <div class="slider-group">
            <div><strong>Contrast</strong> ¬∑ global</div>
            <div class="slider-value"><span id="contrastVal">1.25</span>x</div>
            <input type="range" id="contrast" min="0.8" max="1.8" step="0.05" value="1.25" />
          </div>
          <div class="slider-group">
            <div><strong>Brightness</strong></div>
            <div class="slider-value"><span id="brightnessVal">0</span></div>
            <input type="range" id="brightness" min="-40" max="40" step="2" value="0" />
          </div>
          <div class="slider-group">
            <div><strong>Smoothness</strong> ¬∑ reduce noise</div>
            <div class="slider-value"><span id="smoothVal">0.35</span></div>
            <input type="range" id="smooth" min="0" max="1" step="0.05" value="0.35" />
          </div>
        </div>

        <!-- Soft Sketch sliders -->
        <div class="sliders" id="slidersSketch" style="margin-top:10px; display:none;">
          <div class="slider-group">
            <div><strong>Detail smoothing</strong> ¬∑ blur strength</div>
            <div class="slider-value"><span id="dSmoothVal">0.70</span></div>
            <input type="range" id="detailSmooth" min="0" max="1" step="0.05" value="0.70" />
          </div>
          <div class="slider-group">
            <div><strong>Tone steps</strong> ¬∑ levels</div>
            <div class="slider-value"><span id="toneStepsVal">6</span></div>
            <input type="range" id="toneSteps" min="3" max="9" step="1" value="6" />
          </div>
          <div class="slider-group">
            <div><strong>Edge strength</strong> ¬∑ contour</div>
            <div class="slider-value"><span id="edgeStrengthVal">0.35</span></div>
            <input type="range" id="edgeStrength" min="0" max="1" step="0.05" value="0.35" />
          </div>
          <div class="slider-group">
            <div><strong>Pencil grain</strong> ¬∑ texture</div>
            <div class="slider-value"><span id="pencilGrainVal">0.35</span></div>
            <input type="range" id="pencilGrain" min="0" max="1" step="0.05" value="0.35" />
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: preview -->
    <section class="col">
      <div class="col-inner">
        <div class="label-muted">Preview</div>
        <div class="preview-wrapper">
          <div class="preview-header">
            <span class="title-label">Processed reference</span>
            <div class="view-toggle">
              <button class="view-btn active" id="viewAfter">After</button>
              <button class="view-btn" id="viewBefore">Before</button>
            </div>
          </div>
          <div class="preview-area">
            <canvas id="previewCanvas"></canvas>
            <div class="preview-placeholder" id="placeholder">
              <div class="icon">üñºÔ∏è</div>
              Drop a photo on the left to see the tattoo reference here.
            </div>
          </div>
          <div class="meta">
            <div id="modeInfo">Mode: ‚Äî</div>
            <div id="sizeInfo">No image loaded</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- DOM elements --------------------------------------------------------
    const fileInput      = document.getElementById('fileInput');
    const dropzone       = document.getElementById('dropzone');
    const processBtn     = document.getElementById('processBtn');
    const downloadBtn    = document.getElementById('downloadBtn');
    const resetBtn       = document.getElementById('resetBtn');
    const previewCanvas  = document.getElementById('previewCanvas');
    const placeholder    = document.getElementById('placeholder');
    const sizeInfo       = document.getElementById('sizeInfo');
    const modeInfo       = document.getElementById('modeInfo');
    const slidersTattoo  = document.getElementById('slidersTattoo');
    const slidersSketch  = document.getElementById('slidersSketch');
    const viewAfterBtn   = document.getElementById('viewAfter');
    const viewBeforeBtn  = document.getElementById('viewBefore');

    // sliders ‚Äì tattoo mode
    const contrastSlider   = document.getElementById('contrast');
    const contrastValSpan  = document.getElementById('contrastVal');
    const brightSlider     = document.getElementById('brightness');
    const brightValSpan    = document.getElementById('brightnessVal');
    const smoothSlider     = document.getElementById('smooth');
    const smoothValSpan    = document.getElementById('smoothVal');

    // sliders ‚Äì soft sketch mode
    const dSmoothSlider    = document.getElementById('detailSmooth');
    const dSmoothValSpan   = document.getElementById('dSmoothVal');
    const toneStepsSlider  = document.getElementById('toneSteps');
    const toneStepsValSpan = document.getElementById('toneStepsVal');
    const edgeSlider       = document.getElementById('edgeStrength');
    const edgeValSpan      = document.getElementById('edgeStrengthVal');
    const pencilSlider     = document.getElementById('pencilGrain');
    const pencilValSpan    = document.getElementById('pencilGrainVal');

    const modeRadios   = document.querySelectorAll('input[name="mode"]');

    const defaults = {
      mode: 'tattoo',
      contrast: 1.25,
      brightness: 0,
      smooth: 0.35,
      detailSmooth: 0.70,
      toneSteps: 6,
      edgeStrength: 0.35,
      pencilGrain: 0.35
    };

    // --- state ---------------------------------------------------------------
    let originalImage = null;      // HTMLImageElement
    let originalData  = null;      // ImageData
    let originalW     = 0;
    let originalH     = 0;

    const workCanvas = document.createElement('canvas');
    const workCtx    = workCanvas.getContext('2d');

    let lastOutputData = null;     // ImageData (processed)
    let currentView    = 'after';  // 'after' | 'before'

    // --- helpers -------------------------------------------------------------
    function getSelectedMode() {
      for (const r of modeRadios) if (r.checked) return r.value;
      return 'tattoo';
    }

    function clamp(v, min, max) {
      return v < min ? min : (v > max ? max : v);
    }

    function loadImageToCanvas(img) {
      const maxSide = 1600;
      let { width, height } = img;
      const ratio = width / height;

      if (width > height && width > maxSide) {
        width  = maxSide;
        height = Math.round(maxSide / ratio);
      } else if (height >= width && height > maxSide) {
        height = maxSide;
        width  = Math.round(maxSide * ratio);
      }

      workCanvas.width  = width;
      workCanvas.height = height;
      workCtx.clearRect(0, 0, width, height);
      workCtx.drawImage(img, 0, 0, width, height);
      originalData = workCtx.getImageData(0, 0, width, height);
      originalW = width;
      originalH = height;
      sizeInfo.textContent = `${width}√ó${height}px loaded`;
      lastOutputData = null;
      renderPreview();
    }

    function renderPreview() {
      const ctxPrev = previewCanvas.getContext('2d');
      let data = null;

      if (currentView === 'before' && originalData) {
        data = originalData;
      } else if (lastOutputData) {
        data = lastOutputData;
      } else if (originalData) {
        data = originalData;
      }

      if (!data) return;

      previewCanvas.width  = data.width;
      previewCanvas.height = data.height;
      ctxPrev.putImageData(data, 0, 0);
      placeholder.style.display = 'none';
      downloadBtn.disabled = (currentView === 'before' || !lastOutputData);
    }

    function setProcessedOutput(imageData) {
      lastOutputData = imageData;
      if (currentView === 'before') {
        downloadBtn.disabled = true;
      } else {
        renderPreview();
      }
    }

    // --- core processing: tattoo ref ----------------------------------------
    function processTattooRef() {
      if (!originalData) return;
      const contrast = parseFloat(contrastSlider.value);
      const bright   = parseInt(brightSlider.value, 10);
      const smooth   = parseFloat(smoothSlider.value);

      const src = originalData;
      const w = src.width;
      const h = src.height;
      const out = new ImageData(w, h);
      const sData = src.data;
      const oData = out.data;

      const factor = contrast;
      const bShift = bright;

      for (let i = 0; i < sData.length; i += 4) {
        const r = sData[i];
        const g = sData[i+1];
        const b = sData[i+2];

        let gray = 0.299*r + 0.587*g + 0.114*b;
        gray = (gray - 128) * factor + 128 + bShift;
        gray = clamp(gray, 0, 255);

        oData[i]   = gray;
        oData[i+1] = gray;
        oData[i+2] = gray;
        oData[i+3] = 255;
      }

      const strength = smooth;
      if (strength > 0.01) {
        const radius = 1 + Math.round(strength * 2);
        boxBlurGrayscale(oData, w, h, radius, 1 + Math.round(strength * 2));
      }

      modeInfo.textContent = 'Mode: Tattoo Ref';
      setProcessedOutput(out);
    }

    // --- core processing: soft sketch + pencil grain ------------------------
    function processSoftSketch() {
      if (!originalData) return;

      const smoothStrength = parseFloat(dSmoothSlider.value);
      const toneSteps      = parseInt(toneStepsSlider.value, 10);
      const edgeStrength   = parseFloat(edgeSlider.value);
      const pencilGrain    = parseFloat(pencilSlider.value);

      const src = originalData;
      const w = src.width;
      const h = src.height;
      const grayBase = new Float32Array(w*h);
      const sData = src.data;

      for (let i = 0, p = 0; i < sData.length; i += 4, p++) {
        const r = sData[i];
        const g = sData[i+1];
        const b = sData[i+2];
        grayBase[p] = 0.299*r + 0.587*g + 0.114*b;
      }

      const work = new Float32Array(grayBase);

      if (smoothStrength > 0.01) {
        const radius = 1 + Math.round(smoothStrength * 4);
        const passes = 1 + Math.round(smoothStrength * 2);
        blurMono(work, w, h, radius, passes);
      }

      const levels = toneSteps;
      const step = 255 / (levels - 1);
      for (let i = 0; i < work.length; i++) {
        let g = work[i];
        g = Math.round(g / step) * step;
        work[i] = clamp(g, 0, 255);
      }

      const edges = new Float32Array(w*h);
      sobelEdges(grayBase, w, h, edges);

      let maxE = 0;
      for (let i = 0; i < edges.length; i++) if (edges[i] > maxE) maxE = edges[i];
      const invMaxE = maxE ? 1 / maxE : 1;
      for (let i = 0; i < edges.length; i++) edges[i] = edges[i] * invMaxE;

      const out = new ImageData(w, h);
      const oData = out.data;
      const k = edgeStrength;
      const grainAmp = 24 * pencilGrain; // —Å–∏–ª–∞ "–∫–∞—Ä–∞–Ω–¥–∞—à–∞"

      for (let i = 0, p = 0; p < work.length; p++, i += 4) {
        let g = work[p];
        const e = edges[p];

        // –∫–æ–Ω—Ç—É—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏
        g = g - k * 220 * e;

        // –ª—ë–≥–∫–∞—è –∑–µ—Ä–Ω–∏—Å—Ç–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞ –ø–æ —Å—Ä–µ–¥–Ω–∏–º —Ç–æ–Ω–∞–º
        if (grainAmp > 0.001 && g > 18 && g < 240) {
          const rnd = Math.random() - 0.5; // [-0.5; 0.5]
          g += rnd * grainAmp;
        }

        g = clamp(g, 0, 255);

        oData[i]   = g;
        oData[i+1] = g;
        oData[i+2] = g;
        oData[i+3] = 255;
      }

      modeInfo.textContent = 'Mode: Soft Sketch + pencil grain';
      setProcessedOutput(out);
    }

    // --- blur & sobel helpers -----------------------------------------------
    function blurMono(buf, w, h, radius, passes) {
      const tmp = new Float32Array(buf.length);
      for (let p = 0; p < passes; p++) {
        for (let y = 0; y < h; y++) {
          let acc = 0;
          let count = 0;
          const row = y * w;
          for (let x = -radius; x < w; x++) {
            const addX = x + radius;
            const subX = x - radius - 1;
            if (addX >= 0 && addX < w) {
              acc += buf[row + addX];
              count++;
            }
            if (subX >= 0 && subX < w) {
              acc -= buf[row + subX];
              count--;
            }
            if (x >= 0) buf[row + x] = acc / count;
          }
        }
        for (let x = 0; x < w; x++) {
          let acc = 0;
          let count = 0;
          for (let y = -radius; y < h; y++) {
            const addY = y + radius;
            const subY = y - radius - 1;
            if (addY >= 0 && addY < h) {
              acc += buf[addY * w + x];
              count++;
            }
            if (subY >= 0 && subY < h) {
              acc -= buf[subY * w + x];
              count--;
            }
            if (y >= 0) buf[y * w + x] = acc / count;
          }
        }
      }
    }

    function sobelEdges(src, w, h, out) {
      const gxKernel = [-1,0,1,-2,0,2,-1,0,1];
      const gyKernel = [-1,-2,-1,0,0,0,1,2,1];

      for (let y = 1; y < h-1; y++) {
        for (let x = 1; x < w-1; x++) {
          let gx = 0, gy = 0;
          let k = 0;
          for (let j = -1; j <= 1; j++) {
            for (let i = -1; i <= 1; i++, k++) {
              const idx = (y+j)*w + (x+i);
              const v = src[idx];
              gx += v * gxKernel[k];
              gy += v * gyKernel[k];
            }
          }
          const mag = Math.sqrt(gx*gx + gy*gy);
          out[y*w + x] = mag;
        }
      }
    }

    function boxBlurGrayscale(data, w, h, radius, passes) {
      const mono = new Float32Array(w*h);
      for (let i = 0, p = 0; p < mono.length; p++, i += 4) mono[p] = data[i];
      blurMono(mono, w, h, radius, passes);
      for (let i = 0, p = 0; p < mono.length; p++, i += 4) {
        const g = clamp(mono[p], 0, 255);
        data[i] = data[i+1] = data[i+2] = g;
      }
    }

    // --- events --------------------------------------------------------------
    function handleFiles(files) {
      if (!files || !files.length) return;
      const file = files[0];
      if (!file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          originalImage = img;
          loadImageToCanvas(img);
          processBtn.disabled = false;
          modeChange(); // –∞–≤—Ç–æ-–ø—Ä–æ—Ü–µ—Å—Å
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    dropzone.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    processBtn.addEventListener('click', () => {
      if (!originalData) return;
      if (getSelectedMode() === 'tattoo') processTattooRef();
      else processSoftSketch();
      currentView = 'after';
      updateViewButtons();
      renderPreview();
    });

    downloadBtn.addEventListener('click', () => {
      if (!previewCanvas.width || !previewCanvas.height || !lastOutputData) return;
      const link = document.createElement('a');
      link.download = 'tattoo-reference.png';
      link.href = previewCanvas.toDataURL('image/png');
      link.click();
    });

    resetBtn.addEventListener('click', () => {
      // —Ä–µ–∂–∏–º
      modeRadios.forEach(r => { r.checked = (r.value === defaults.mode); });
      // —Å–ª–∞–π–¥–µ—Ä—ã
      contrastSlider.value   = defaults.contrast;
      brightSlider.value     = defaults.brightness;
      smoothSlider.value     = defaults.smooth;
      dSmoothSlider.value    = defaults.detailSmooth;
      toneStepsSlider.value  = defaults.toneSteps;
      edgeSlider.value       = defaults.edgeStrength;
      pencilSlider.value     = defaults.pencilGrain;

      // –ø–æ–¥–ø–∏—Å–∏
      contrastValSpan.textContent  = defaults.contrast.toFixed(2);
      brightValSpan.textContent    = defaults.brightness;
      smoothValSpan.textContent    = defaults.smooth.toFixed(2);
      dSmoothValSpan.textContent   = defaults.detailSmooth.toFixed(2);
      toneStepsValSpan.textContent = defaults.toneSteps;
      edgeValSpan.textContent      = defaults.edgeStrength.toFixed(2);
      pencilValSpan.textContent    = defaults.pencilGrain.toFixed(2);

      currentView = 'after';
      updateViewButtons();
      modeChange();
    });

    function modeChange() {
      const mode = getSelectedMode();
      if (mode === 'tattoo') {
        slidersTattoo.style.display = 'grid';
        slidersSketch.style.display = 'none';
      } else {
        slidersTattoo.style.display = 'grid';
        slidersSketch.style.display = 'grid';
      }
      if (originalData) {
        if (mode === 'tattoo') processTattooRef();
        else processSoftSketch();
        currentView = 'after';
        updateViewButtons();
        renderPreview();
      }
    }
    modeRadios.forEach(r => r.addEventListener('change', modeChange));

    function hookSlider(slider, span, format, mode) {
      const update = () => {
        span.textContent = typeof format === 'function' ? format(slider.value) : slider.value;
        if (!originalData) return;
        if (getSelectedMode() === mode) {
          if (mode === 'tattoo') processTattooRef();
          else processSoftSketch();
          currentView = 'after';
          updateViewButtons();
          renderPreview();
        }
      };
      slider.addEventListener('input', update);
      update();
    }

    hookSlider(contrastSlider, contrastValSpan, v => Number(v).toFixed(2), 'tattoo');
    hookSlider(brightSlider,   brightValSpan,   v => parseInt(v,10),        'tattoo');
    hookSlider(smoothSlider,   smoothValSpan,   v => Number(v).toFixed(2), 'tattoo');

    hookSlider(dSmoothSlider,  dSmoothValSpan,  v => Number(v).toFixed(2), 'sketch');
    hookSlider(toneStepsSlider,toneStepsValSpan,v => parseInt(v,10),       'sketch');
    hookSlider(edgeSlider,     edgeValSpan,     v => Number(v).toFixed(2), 'sketch');
    hookSlider(pencilSlider,   pencilValSpan,   v => Number(v).toFixed(2), 'sketch');

    function updateViewButtons() {
      if (currentView === 'after') {
        viewAfterBtn.classList.add('active');
        viewBeforeBtn.classList.remove('active');
      } else {
        viewBeforeBtn.classList.add('active');
        viewAfterBtn.classList.remove('active');
      }
      renderPreview();
    }

    viewAfterBtn.addEventListener('click', () => {
      currentView = 'after';
      updateViewButtons();
    });

    viewBeforeBtn.addEventListener('click', () => {
      currentView = 'before';
      updateViewButtons();
    });
  </script>
</body>
</html>